<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>심캘</title>
  <style>
    /* 기존 스타일 그대로 유지됨 */
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding: 0 10px;
      background: #fff;
    }
    #controls {
      margin: 15px 0;
      user-select: none;
    }
    button {
      font-size: 1.4rem;
      padding: 8px 15px;
      margin: 0 5px;
      border: none;
      border-radius: 5px;
      background: #3a86ff;
      color: white;
      cursor: pointer;
      min-width: 50px;
      transition: background 0.3s;
    }
    button:hover {
      background: #265ddb;
    }
    h2#monthTitle {
      display: inline-block;
      margin: 0 10px;
      font-size: 1.5rem;
    }
    table {
      border-collapse: collapse;
      margin: 0 auto 30px;
      width: 100%;
      max-width: 600px;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #000000;
      vertical-align: top;
      position: relative;
      cursor: pointer;
      word-break: break-word;
      padding: 4px 6px 6px 6px;
      user-select: none;
    }
    th {
      height: 30px;
      font-weight: bold;
      font-size: 1.1rem;
      background: #f0f0f0;
    }
    td {
      height: 90px;
      font-size: 1rem;
    }
    .date {
      position: absolute;
      top: 4px;
      left: 6px;
      font-size: 1rem;
      color: #000000;
      font-weight: 600;
    }
    .memo {
      font-size: 0.9rem;
      white-space: normal;
      overflow-wrap: break-word;
      word-break: break-word;
      min-height: 40px;
      /* 공휴일이 없을 때 날짜 아래에 공간 확보 위해 margin-top 조절 */
      margin-top: 24px; 
      position: relative;
      top: 0;
    }
    /* 공휴일이 있으면 메모를 조금 아래로 내려줌 */
    .memo.below-holiday {
      margin-top: 6px;
      position: relative;
      top: 0;
    }
    .holiday-name {
      margin-top: 24px;
      font-size: 0.9rem;
      font-weight: bold;
      color: red;
      white-space: normal;
      overflow-wrap: break-word;
      word-break: break-word;
    }
    .yellow {
      background-color: #fff8b3;
    }
    .blue {
      background-color: #b3daff;
    }
    .gray {
      background-color: #e0e0e0;
    }
    .sun {
      color: red !important;
    }
    .sat {
      color: blue !important;
    }
    .dimmed {
      color: #838383 !important;
    }
    .holiday {
      color: red !important;
      font-weight: 700;
    }
    #popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 1px solid #aaa;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
      display: none;
      z-index: 1000;
      width: 90%;
      max-width: 320px;
      border-radius: 8px;
      user-select: text;
    }
    #popup b {
      display: block;
      margin-bottom: 12px;
      font-size: 1.1rem;
    }
    #popup input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      font-size: 1rem;
      margin-bottom: 12px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    #popup div label {
      font-size: 1rem;
      margin-right: 12px;
      cursor: pointer;
      user-select: none;
    }
    #popup div input[type="radio"] {
      cursor: pointer;
      vertical-align: middle;
      margin-right: 4px;
    }
    #popup button {
      font-size: 1.1rem;
      padding: 8px 15px;
      margin: 6px 6px 0 0;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      min-width: 80px;
      user-select: none;
      transition: background 0.3s;
    }
    #popup button:first-of-type {
      background-color: #3a86ff;
      color: white;
    }
    #popup button:first-of-type:hover {
      background-color: #265ddb;
    }
    #popup button:last-of-type {
      background-color: #ccc;
    }
    #popup button:last-of-type:hover {
      background-color: #999;
    }
    #overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      z-index: 900;
    }
    @media (max-width: 480px) {
      th, td {
        font-size: 0.85rem;
        height: 70px;
        padding: 2px 4px 4px 4px;
      }
      .date {
        font-size: 0.9rem;
      }
      .memo {
        margin-top: 24px;
        font-size: 0.8rem;
        min-height: 35px;
      }
      .memo.below-holiday {
        margin-top: 6px;
      }
      button {
        font-size: 1.3rem;
        padding: 6px 10px;
        min-width: 45px;
      }
      h2#monthTitle {
        font-size: 1.2rem;
      }
      #popup {
        width: 95%;
        max-width: none;
        padding: 15px;
      }
      #popup input[type="text"] {
        font-size: 0.95rem;
      }
      #popup div label {
        font-size: 0.9rem;
      }
      #popup button {
        font-size: 1rem;
        padding: 7px 12px;
        min-width: 70px;
      }
    }
  </style>
  <link rel="manifest" href="manifest.json" />
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>
</head>
<body>
    <div id="topControls" style="display: flex; justify-content: flex-start; margin: 15px 0; user-select: none;">
      <button onclick="resetAll()" style="position: fixed; top: 10px; left: 10px; background: #ff4d4d; color: white; border: none; border-radius: 5px; padding: 4px 10px; font-size: 1rem; cursor: pointer; z-index: 1100; user-select: none;">
        초기화
      </button>
    </div>
    <div id="controls" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin: 50px 0 15px 0; user-select: none;">
      <button onclick="changeMonth(-1)" style="min-width: 40px; padding: 6px 10px;">&lt;</button>
      <h2 id="monthTitle" style="margin: 0 10px; font-size: 1.5rem;"></h2>
      <button onclick="changeMonth(1)" style="min-width: 40px; padding: 6px 10px;">&gt;</button>
    </div>
  <table id="calendar"></table>

  <div id="overlay"></div>
  <div id="popup">
    <b id="popupDate"></b>
    <input type="text" id="memoInput" placeholder="메모를 입력하세요" maxlength="50" />
    <div>
      <label><input type="radio" name="color" value="" /> 없음</label>
      <label><input type="radio" name="color" value="yellow" /> 노랑</label>
      <label><input type="radio" name="color" value="blue" /> 파랑</label>
      <label><input type="radio" name="color" value="gray" /> 회색</label>
    </div>
    <div>
      <b>글자색</b><br />
      <label><input type="radio" name="memoColor" value="black" checked /> 검정</label>
      <label><input type="radio" name="memoColor" value="red" /> 빨강</label>
      <label><input type="radio" name="memoColor" value="blue" /> 파랑</label>
    </div>
    <button onclick="saveMemo()">저장</button>
    <button onclick="closePopup()">취소</button>
  </div>

  <script>
    let current = new Date();
    current.setDate(1);

    const calendar = document.getElementById('calendar');
    const monthTitle = document.getElementById('monthTitle');
    const popup = document.getElementById('popup');
    const overlay = document.getElementById('overlay');
    const memoInput = document.getElementById('memoInput');
    const popupDate = document.getElementById('popupDate');

    let selectedDate = '';

    let holidays = new Map();

    async function fetchHolidays(year, month) {
      const serviceKey = '8JrZ7bV8ldqfBkPw2jiJG8RBfL559YI%2Fk2FYcNRGLUiIE9XSl7Oae%2BeLSnTOmotMf35yk8pBsSIB0NWvhoJOaw%3D%3D';
      const url = `https://apis.data.go.kr/B090041/openapi/service/SpcdeInfoService/getRestDeInfo?serviceKey=${serviceKey}&solYear=${year}&solMonth=${String(month).padStart(2, '0')}&_type=json`;

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('네트워크 응답 오류');
        const data = await res.json();

        holidays.clear();

        const items = data.response?.body?.items?.item;

        if (Array.isArray(items)) {
          for (const day of items) {
            if (day?.isHoliday === 'Y') {
              const d = day.locdate.toString();
              // 공휴일 키는 YYYY-M-D (0채움 없이)
              const formatted = `${d.slice(0,4)}-${parseInt(d.slice(4,6))}-${parseInt(d.slice(6,8))}`;
              holidays.set(formatted, day.dateName);
            }
          }
        } else if (items && items.isHoliday === 'Y') {
          const d = items.locdate.toString();
          const formatted = `${d.slice(0,4)}-${parseInt(d.slice(4,6))}-${parseInt(d.slice(6,8))}`;
          holidays.set(formatted, items.dateName);
        }
      } catch (e) {
        console.error('공휴일 API 호출 실패:', e);
        holidays.clear();
      }
    }

    async function buildCalendar() {
      const year = current.getFullYear();
      const month = current.getMonth();

      await fetchHolidays(year, month + 1);

      monthTitle.innerText = `${year}년 ${month + 1}월`;

      let html = '<tr>';
      ['일', '월', '화', '수', '목', '금', '토'].forEach(
        (day) => (html += `<th>${day}</th>`)
      );
      html += '</tr><tr>';

      const firstDay = new Date(year, month, 1).getDay();
      const lastDate = new Date(year, month + 1, 0).getDate();
      const prevLastDate = new Date(year, month, 0).getDate();
      const startOffset = firstDay;

      let day = 1;
      let nextDay = 1;

      for (let i = 0; i < 6 * 7; i++) {
        let dateClass = '';
        let displayDate = '';
        let fullDate = '';

        const weekDay = i % 7;
        if (i < startOffset) {
          const prevDate = prevLastDate - startOffset + i + 1;
          fullDate = `${year}-${month}-${prevDate}`;
          displayDate = prevDate;
          dateClass = 'dimmed';
        } else if (day <= lastDate) {
          fullDate = `${year}-${month + 1}-${day}`;
          displayDate = day;

          if (holidays.has(fullDate)) {
            dateClass += ' holiday';
          } else {
            if (weekDay === 0) dateClass += ' sun';
            if (weekDay === 6) dateClass += ' sat';
          }

          day++;
        } else {
          fullDate = `${year}-${month + 2}-${nextDay}`;
          displayDate = nextDay;
          nextDay++;
          dateClass = 'dimmed';
        }

        // 저장 데이터 읽기
        const saved = JSON.parse(localStorage.getItem(fullDate) || '{}');
        const colorClass = saved.color || '';
        const memo = saved.memo || '';
        const memoColor = saved.memoColor || 'black';
        const holidayName = holidays.get(fullDate) || '';

        // holidayName 있을 때와 없을 때 메모 CSS 클래스 분기 처리
        const memoClass = holidayName ? 'memo below-holiday' : 'memo';

        html += `<td class="${colorClass}" onclick="openPopup('${fullDate}')">
                   <div class="date ${dateClass}">${displayDate}</div>
                   ${holidayName ? `<div class="holiday-name">${holidayName}</div>` : ''}
                   <div class="${memoClass}" style="color:${memoColor};">${memo}</div>
                 </td>`;
        if (i % 7 === 6) html += '</tr><tr>';
      }

      html += '</tr>';
      calendar.innerHTML = html;
    }

    function changeMonth(offset) {
      const newMonth = new Date(current.getFullYear(), current.getMonth() + offset, 1);
      if (newMonth.getFullYear() >= 2025) {
        current = newMonth;
        buildCalendar();
      }
    }

    function openPopup(dateStr) {
      selectedDate = dateStr;
      popupDate.innerText = dateStr;
      const saved = JSON.parse(localStorage.getItem(dateStr) || '{}');
      memoInput.value = saved.memo || '';
      document.querySelectorAll('input[name="color"]').forEach((r) => {
        r.checked = r.value === (saved.color || '');
      });
      document.querySelectorAll('input[name="memoColor"]').forEach((r) => {
        r.checked = r.value === (saved.memoColor || 'black');
      });
      popup.style.display = 'block';
      overlay.style.display = 'block';
    }

    function closePopup() {
      popup.style.display = 'none';
      overlay.style.display = 'none';
    }

    function saveMemo() {
      const memo = memoInput.value.trim();
      const color = document.querySelector('input[name="color"]:checked').value;
      const memoColor = document.querySelector('input[name="memoColor"]:checked').value;

      localStorage.setItem(
        selectedDate,
        JSON.stringify({ memo, color, memoColor })
      );
      closePopup();
      buildCalendar();
    }

    function resetAll() {
      if (confirm('메모와 색깔을 모두 초기화하시겠습니까?')) {
        // 로컬스토리지에서 달력 관련 데이터 모두 삭제
        // 여기선 저장키가 'YYYY-M-D' 형식임을 이용
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(key)) {
            localStorage.removeItem(key);
            // localStorage 길이 변해서 인덱스 주의 필요
            i--;
          }
        }
        buildCalendar();
      }
    }

    buildCalendar();
  </script>
</body>
</html>